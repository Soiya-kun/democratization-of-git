# 03 起動/操作フロー

## 0. 前提: Git

- Gitが未導入、または `git` コマンドが見つからない場合は案内を表示し、履歴機能は無効化する

## 1. 起動時導線

### 1.1 フォルダ未選択

- 「作業フォルダを開く」導線を提示する

### 1.2 Git未初期化フォルダ: 「新たなプロジェクトを開始する」

- 実行内容:
  - (1) `git init -b main` を実行して `main` を作成する
  - (2) ローカル設定を行う
    - `user.name` / `user.email` を設定する (初回設定が未入力なら先に入力させる)
    - 管理マークを設定する
      - `democratization-of-git.managed=true`
      - `democratization-of-git.version=1`
  - (3) `.gitignore` を自動生成する (存在する場合は上書きしない)
    - 中身はコメントのみ (テンプレート)
  - (4) `AGENTS.md` を作成する (存在する場合は上書きしない)
    - 内容:
      - 「このフォルダの履歴はこのアプリで管理します。」
      - 「作業を始めるときはアプリで『作業を開始する』を選んでください。」
  - (5) 現在の状態を最初の履歴として保存する
    - すべて追加(`add -A`) → メッセージ「プロジェクト開始」で履歴保存
  - (6) 以後はメイン(閲覧専用)として開く

### 1.3 既存Gitリポジトリ

- `main` が無い場合は例外としてエラー表示する
- `main` がある場合は、このアプリで扱える
  - 管理マーク(`democratization-of-git.managed=true`)を設定する

### 1.4 起動時のブランチ補正

アプリ起動時(フォルダを開いた直後)に、現在のブランチを確認して以下のように扱う。

- 現在のブランチが `work-*`: そのまま作業を再開する
- 現在のブランチが `main`: main(閲覧専用)として開く
- 現在のブランチが `main`/`work-*` 以外: `main` に切り替えてから main(閲覧専用)として開く
  - 切り替えに失敗する場合は、エラーを表示し、必要なら差分破棄(リセット)へ誘導する

## 2. メイン(閲覧専用)のUX

- メインで表示する内容:
  - 変更の閲覧、履歴の閲覧、差分の閲覧
- メインで禁止する操作 (MVP):
  - 「次の履歴に含める/含めない」「履歴を保存」「変更を取り消す」など、状態を変更する操作
- メインからの導線:
  - 「作業を開始する」: ワークが無い場合に作業名入力へ
  - 「作業を再開する」: ワークがある場合に再開

### 2.1 外部アプリによる変更が検知された場合

- メイン表示中に差分が検知された場合:
  - ワークが無い:
    - 「新しい作業を開始する」: 差分を維持したままワークを作成して作業へ移る
    - 「元に戻す(リセット)」: 差分を破棄してメインをクリーンに戻す
  - ワークがある:
    - 「作業を再開する」: 差分を破棄してからワークへ戻る (詳細は 3.3)
- リセット確認文言:
  - 「元に戻すと、変更は取り消され、未追跡のファイルも削除されます。元に戻せません。よろしいですか？」

## 3. ワーク開始/再開

### 3.1 ワークが無い (`work-*` が無い)

- 「この作業に名前を付けてください」
- 作業名を入力 → `work-<作業名>` を作成して切り替える

### 3.2 ワークがある (`work-*` がある)

- 「作業途中のワークがあります。作業から再開し、それを完了してください。」
- `work-*` が複数あれば、最終更新が最新のものを採用して再開する
- ワーク内に未保存の差分がある場合も、そのまま「作業内容」として扱う

### 3.3 メイン→ワークへ戻るときの差分

- メイン上に差分がある状態でワークへ戻る(再開)場合、その差分は破棄してから切り替える
  - 追跡ファイル: 変更を取り消してメインの状態へ戻す
  - 未追跡ファイル: 破棄する

## 4. 基本操作 (MVP)

### 4.1 変更一覧

- 表示カテゴリ例:
  - 「次の履歴に含める変更」(staged)
  - 「まだ含めない変更」(unstaged)
  - 「新しく追加されたファイル」(untracked)

### 4.2 変更内容の確認

- ファイル選択で変更内容を表示する
- untrackedはMVPでは「ファイル内容表示」を基本とする (diff生成は将来)
- 表示の上限/例外:
  - 巨大diffは上限を設け、「変更箇所が多すぎるため表示できません」と案内する
    - 目安: `diff` テキストが 1,000,000 文字を超える場合は省略表示
  - バイナリは表示しない (「バイナリファイルのため表示できません」と案内)
  - リネームは、ステージ済みの段階で検知できる場合は「名前が変更されました」と表示する

### 4.3 次の履歴に含める/含めない

- ファイル単位/まとめて操作を提供する
- UI文言は「含める/含めない」を使用する

### 4.4 変更を取り消す (破壊操作)

- 「取り消し」前に確認ダイアログを必須にする
- 未追跡ファイルも削除されることを明示する
- 操作粒度:
  - ファイル単位
  - 選択したファイルのみ
  - すべて

### 4.5 この修正の履歴を保存する

- “commit” という語は使わない
- 画面に説明文を置く: 「今の状態を後から見返せるように保存します」
- メッセージ入力:
  - MVPは「メモ(任意)」でOK
  - 空の場合は日付等で自動生成してよい

## 5. 作業を完了する

ユーザー導線上「完了」が必要なため、Git用語を出さずに取りまとめを提供する。

- 基本動作:
  - (0) 未保存の変更がある場合は、すべて自動で履歴に残す
    - 含める/含めない状態に関わらず、すべて含める(=add -A) → メッセージ「自動保存(完了前)」で履歴保存
  - (1) main へ fast-forward merge (`--ff-only`) を試みる
  - (2) main へ切り替える
  - (3) 作業用ワーク(ブランチ)を削除する
  - 結果: 次回起動時に「mainのみ」状態になり、新しい作業名入力へ進める
- 例外(衝突など):
  - UIで「自動では完了できません」と表示し、対応方法を案内する (将来: 解決UI)
